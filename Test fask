local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

local function showNotification(title, text, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title;
        Text = text;
        Duration = duration;
    })
end

local function createUI()
    local ScreenGui = Instance.new("ScreenGui")
    local Frame = Instance.new("Frame")
    local TitleLabel = Instance.new("TextLabel")
    local StatusLabel = Instance.new("TextLabel")

    ScreenGui.Parent = game.CoreGui

    Frame.Parent = ScreenGui
    Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Frame.BorderSizePixel = 2
    Frame.Position = UDim2.new(0.35, 0, 0.1, 0)
    Frame.Size = UDim2.new(0.3, 0, 0.12, 0)
    Frame.BackgroundTransparency = 0.5

    TitleLabel.Parent = Frame
    TitleLabel.Size = UDim2.new(1, 0, 0.3, 0)
    TitleLabel.Text = "üîπPlow Hubüîπ"
    TitleLabel.TextScaled = true
    TitleLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
    TitleLabel.BackgroundTransparency = 1

    StatusLabel.Parent = Frame
    StatusLabel.Size = UDim2.new(1, 0, 0.7, 0)
    StatusLabel.Position = UDim2.new(0, 0, 0.3, 0)
    StatusLabel.Text = "ƒêang ki·ªÉm tra tr√°i √°c qu·ª∑..."
    StatusLabel.TextScaled = true
    StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    StatusLabel.BackgroundTransparency = 1

    return StatusLabel
end

local function flyToPosition(targetPosition, speed)
    if not HumanoidRootPart then return end
    local distance = (targetPosition - HumanoidRootPart.Position).magnitude
    local duration = distance / speed

    for _, v in pairs(Character:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = false
        end
    end

    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Linear)
    local tween = game:GetService("TweenService"):Create(HumanoidRootPart, tweenInfo, {CFrame = CFrame.new(targetPosition)})
    tween:Play()
    tween.Completed:Wait()

    for _, v in pairs(Character:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = true
        end
    end
end

local function findNearestFruit(uiLabel)
    local closestFruit = nil
    local closestDistance = math.huge

    for _, fruit in pairs(Workspace:GetChildren()) do
        if fruit:IsA("Model") and fruit.Name:find("Fruit") and fruit:FindFirstChild("Handle") then
            local distance = (fruit.Handle.Position - HumanoidRootPart.Position).magnitude
            if distance < closestDistance then
                closestDistance = distance
                closestFruit = fruit
            end
        end
    end

    if closestFruit then
        showNotification("Plow Hub | Auto Fruit", "T√¨m th·∫•y tr√°i " .. closestFruit.Name, 3)
        uiLabel.Text = "T√¨m th·∫•y tr√°i: " .. closestFruit.Name
        return closestFruit
    end

    uiLabel.Text = "Kh√¥ng c√≥ tr√°i √°c qu·ª∑"
    return nil
end

local function storeFruitInInventory(fruit)
    if fruit and fruit:FindFirstChild("Handle") then
        local args = {
            [1] = fruit.Name,
            [2] = fruit.Handle.Position
        }
        ReplicatedStorage.Remotes:FindFirstChild("StoreFruit"):InvokeServer(unpack(args))
        showNotification("Plow Hub | Auto Fruit", "ƒê√£ l∆∞u " .. fruit.Name .. " v√†o kho!", 3)
        return true
    end
    return false
end

local function switchServerAfterDelay(uiLabel)
    print("Kh√¥ng c√≥ tr√°i, ch·ªù 7 gi√¢y tr∆∞·ªõc khi ƒë·ªïi server...")
    uiLabel.Text = "Kh√¥ng c√≥ tr√°i! Ch·ªù 7 gi√¢y..."
    showNotification("Plow Hub | Auto Fruit", "Kh√¥ng c√≥ tr√°i! ƒêang ch·ªù 7 gi√¢y...", 7)
    wait(7) 
    TeleportService:Teleport(game.PlaceId, LocalPlayer)
end

local function checkAndStoreFruit(uiLabel)
    local fruit = findNearestFruit(uiLabel)

    if fruit then
        showNotification("Plow Hub | Auto Fruit", "ƒêang nh·∫∑t tr√°i...", 3)
        uiLabel.Text = "ƒêang nh·∫∑t tr√°i..."
        
        flyToPosition(fruit.Handle.Position, 200)
        wait(1)

        local success = storeFruitInInventory(fruit)
        if success then
            uiLabel.Text = "ƒê√£ l∆∞u tr√°i v√†o kho!"
        else
            uiLabel.Text = "Kh√¥ng th·ªÉ l∆∞u tr√°i!"
        end
    else
        switchServerAfterDelay(uiLabel)
    end
end

local function startScript()
    local uiLabel = createUI()
    checkAndStoreFruit(uiLabel)
end

startScript()
