local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer

-- 📌 Webhook Discord (Thay bằng link webhook của bạn)
local WebhookURL = "https://discord.com/api/webhooks/1353331618802044928/HWkDOTGUkOz_IWQGzdYVz-7aK75-R5yDN07Lw2PIpNkeo3Szj6Gv2N5S3sdWwGcXEDfj"

-- 📌 Hiển thị thông báo trên màn hình
local function showNotification(title, text, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title;
        Text = text;
        Duration = duration;
    })
end

-- 📌 Gửi thông báo khi khởi động script
local function startupMessage()
    showNotification("🔹 Plow Hub | Auto Fruit 🔹", "🚀 Đang tìm trái ác quỷ...", 5)
end

-- 📌 Gửi thông báo đến Discord Webhook
local function sendDiscordMessage(fruitName, fruitPosition)
    local data = {
        ["username"] = "Plow Hub | Auto Fruit",
        ["embeds"] = {{
            ["title"] = "🍏 Tìm thấy trái ác quỷ!",
            ["description"] = "**Tên Trái:** " .. fruitName .. "\n**Vị trí:** " .. tostring(fruitPosition),
            ["color"] = 16711680 -- Màu đỏ
        }}
    }

    local jsonData = HttpService:JSONEncode(data)
    HttpService:PostAsync(WebhookURL, jsonData, Enum.HttpContentType.ApplicationJson)
end

-- 📌 Lấy danh sách server chỉ ở Singapore 🇸🇬
local function getSingaporeServers()
    local url = "https://games.roblox.com/v1/games/2753915549/servers/Public?sortOrder=Asc&limit=100"
    local success, response = pcall(function() return game:HttpGet(url) end)

    if not success then
        print("❌ Lỗi lấy danh sách server:", response)
        return {}
    end

    local data = HttpService:JSONDecode(response)
    local singaporeServers = {}

    for _, server in pairs(data.data) do
        if server.region == "Singapore" and server.playing < server.maxPlayers then
            table.insert(singaporeServers, server.id)
        end
    end

    return singaporeServers
end

-- 📌 Đổi server (Siêu nhanh, chỉ đến server Singapore 🇸🇬)
local function fastTeleportToSingaporeServer()
    local servers = getSingaporeServers()
    if #servers > 0 then
        local randomServer = servers[math.random(1, #servers)]
        print("✅ Đang chuyển đến server Singapore:", randomServer)
        showNotification("Plow Hub | Auto Fruit", "Đang đổi server...", 2)
        TeleportService:TeleportToPlaceInstance(game.PlaceId, randomServer, LocalPlayer)
    else
        print("❌ Không tìm thấy server Singapore! Đổi server khác...")
        showNotification("Plow Hub | Auto Fruit", "Không tìm thấy server! Đang đổi server...", 2)
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
    end
end

-- 📌 Tìm trái ác quỷ gần nhất
local function findNearestFruit()
    for _, fruit in pairs(Workspace:GetChildren()) do
        if fruit:IsA("Model") and fruit.Name:find("Fruit") and fruit:FindFirstChild("Handle") then
            local fruitPosition = fruit.Handle.Position
            showNotification("Plow Hub | Auto Fruit", "Đã tìm thấy trái " .. fruit.Name .. "!", 3)
            sendDiscordMessage(fruit.Name, fruitPosition)
            return fruit
        end
    end
    return nil
end

-- 📌 Tự động lưu trái vào kho
local function storeFruitInInventory(fruit)
    if fruit and fruit:FindFirstChild("Handle") then
        -- Teleport đến trái
        LocalPlayer.Character.HumanoidRootPart.CFrame = fruit.Handle.CFrame
        wait(1) -- Đợi 1 giây để nhặt trái

        -- Nhặt trái
        fireclickdetector(fruit.Handle:FindFirstChild("ClickDetector"))
        wait(2) -- Đợi 2 giây để chắc chắn đã nhặt

        -- Mở kho đồ
        local args = { [1] = "Open" }
        ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args))
        wait(1)

        -- Lưu trái vào kho
        local args2 = { [1] = "StoreFruit" }
        ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args2))
        wait(1)

        showNotification("Plow Hub | Auto Fruit", "✅ Đã lưu trái vào kho!", 3)
    end
end

-- 📌 Kiểm tra nếu có trái thì lưu vào kho, nếu không thì chờ 5 giây rồi đổi server
local function checkAndStoreFruit()
    local fruit = findNearestFruit()

    if fruit then
        storeFruitInInventory(fruit)
    else
        print("❌ Không có trái! Chờ 5 giây trước khi đổi server...")
        showNotification("Plow Hub | Auto Fruit", "Không có trái! Đang chờ 5 giây...", 5)
        wait(5) -- ⏳ Chờ 5 giây trước khi đổi server
        fastTeleportToSingaporeServer()
    end
end

-- 📌 Bắt đầu script
local function startScript()
    startupMessage() -- Hiển thị thông báo khi chạy script
    checkAndStoreFruit()
end

startScript()
